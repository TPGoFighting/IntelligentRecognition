# 智能形状识别系统 - 新手使用手册

> 一款基于深度学习的3D点云形状自动检测与识别软件

---

## 目录

1. [软件简介](#软件简介)
2. [系统要求](#系统要求)
3. [安装说明](#安装说明)
4. [快速开始](#快速开始)
5. [界面说明](#界面说明)
6. [功能详解](#功能详解)
7. [常见问题](#常见问题)
8. [进阶使用](#进阶使用)

---

## 软件简介

### 什么是智能形状识别系统？

这是一个能够自动识别3D点云数据中各种几何形状的人工智能软件。它可以：

- 🔍 **自动识别**：从点云中识别圆柱体、球体、平面、隧道等多种形状
- 🎯 **高精度检测**：基于PointNet++深度学习模型，识别准确率高
- 📊 **可视化显示**：直观的3D界面，实时展示检测结果
- 📤 **数据导出**：支持将检测结果导出为JSON格式
- 🚀 **批量处理**：一次处理多个文件，提高工作效率

### 适用场景

- 隧道施工监测
- 工业管道检测
- 逆向工程建模
- 建筑结构分析
- 科研教学演示

---

## 系统要求

### 硬件要求

| 组件     | 最低配置        | 推荐配置               |
| -------- | --------------- | ---------------------- |
| CPU      | Intel i5 或同级 | Intel i7 或更高        |
| 内存     | 8GB             | 16GB 或更高            |
| 显卡     | NVIDIA GTX 1050 | NVIDIA RTX 3060 或更高 |
| 存储     | 10GB 可用空间   | 50GB SSD               |
| 操作系统 | Windows 10/11   | Windows 11             |

> **注意**：如果使用CPU模式，检测速度会明显变慢，推荐使用NVIDIA显卡。

### 软件要求

- Python 3.8 或更高版本
- NVIDIA 显卡驱动（如使用GPU）
- 以下Python库会自动安装：
  - PyTorch
  - Open3D
  - PyQt5
  - PyVista
  - NumPy

---

## 安装说明

### 步骤一：安装Python

1. 访问 [Python官网](https://www.python.org/downloads/)
2. 下载Python 3.8或更高版本
3. 安装时**务必勾选"Add Python to PATH"**

### 步骤二：安装依赖库

打开命令提示符（CMD）或PowerShell，进入软件目录，运行：

```bash
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
pip install open3d pyqt5 pyvista pyvistaqt numpy pyyaml
```

或者使用requirements.txt（如果有的话）：

```bash
pip install -r requirements.txt
```

### 步骤三：验证安装

运行以下命令检查是否安装成功：

```bash
python main.py
```

如果看到软件窗口弹出，说明安装成功！

---

## 快速开始

### 最简单的使用流程

```
1. 打开软件
2. 点击"加载模型权重"，选择 .pth 模型文件
3. 点击"导入点云文件"，选择您的点云数据
4. 点击"运行通用检测"
5. 查看检测结果
6. （可选）点击"导出检测JSON"保存结果
```

---

## 界面说明

### 整体布局

软件界面分为两个主要区域：

```
┌─────────────────────────────────────────────────────────┐
│  通用控制面板            │        3D显示区域          │
│                         │                              │
│  [配置与模型]            │        ┌──────────┐         │
│  ├ 加载配置文件           │        │          │         │
│  ├ 加载模型权重           │        │  点云    │         │
│  └ 配置/模型状态          │        │  显示    │         │
│                         │        │          │         │
│  [数据与推理]            │        └──────────┘         │
│  ├ 导入点云文件           │                              │
│  ├ 运行通用检测           │    ┌──────────────────┐    │
│  └ 运行隧道检测(旧版)      │    │  日志窗口        │    │
│                         │    │  显示处理进度    │    │
│  [检测结果]              │    └──────────────────┘    │
│  ├ 导出检测JSON           │                              │
│  └ 清除场景              │                              │
│  ...更多功能...           │                              │
└─────────────────────────────────────────────────────────┘
```

### 左侧：控制面板

所有操作按钮都在左侧，按功能分组排列。

### 右侧：3D显示区

- 上方是3D点云的可视化窗口，可以用鼠标旋转、缩放、平移
- 下方是日志窗口，显示处理进度和结果信息

---

## 功能详解

### 一、配置与模型

#### 1. 加载配置文件 (YAML)

**用途**：加载软件的配置文件，定义需要识别的形状类型。

**操作步骤**：

1. 点击"加载配置文件"按钮
2. 在弹出的文件选择框中找到 `config/shape_config.yaml`
3. 选择并打开

**说明**：

- 配置文件定义了系统支持的形状类型（如圆柱、球体、平面等）

- 每种形状的检测参数也在配置文件中设置

- 配置文件示例结构：

  ```yaml
  shapes:
    - cylinder: 圆柱体
    - sphere: 球体
    - plane: 平面
  ```

#### 2. 加载模型权重 (.pth)

**用途**：加载训练好的深度学习模型。

**操作步骤**：

1. 点击"加载模型权重"按钮
2. 选择 `.pth` 格式的模型文件
3. 通常位于 `models/universal/` 目录下

**重要提示**：

- 模型文件必须与配置文件匹配
- 模型文件通常较大（几十MB到几百MB）
- 首次加载可能需要几秒钟

---

### 二、数据与推理

#### 1. 导入点云文件

**用途**：加载待检测的3D点云数据。

**支持格式**：

- `.ply` - 标准点云格式
- `.pcd` - PCL点云格式
- `.npz` - NumPy压缩格式
- `.npy` - NumPy数组格式
- `.txt` - 纯文本格式

**操作步骤**：

1. 点击"导入点云文件"按钮
2. 选择点云文件
3. 等待加载完成（点云大小会影响加载时间）

**注意事项**：

- 点云文件过大（超过1000万点）会自动进行下采样
- 下采样会保留点云的主要特征
- 日志窗口会显示原始点数和处理后的点数

#### 2. 运行通用检测 ⭐推荐

**用途**：使用最新的通用模型进行形状检测，支持多种形状。

**操作步骤**：

1. 确保已加载配置和模型
2. 确保已导入点云文件
3. 点击"运行通用检测"按钮
4. 等待检测完成

**检测过程**：

1. 系统将点云分成多个小窗口
2. 对每个窗口进行深度学习分类
3. 使用RANSAC算法拟合每个检测到的形状
4. 统计投票结果，输出最终检测结果

**结果显示**：

- 检测到的形状会用不同颜色在3D视图中高亮显示
- 日志窗口会显示：
  - 检测到的物体总数
  - 每种形状的数量
  - 每个物体的置信度、类型、点数

#### 3. 运行隧道检测(旧版)

**用途**：使用旧版本算法专门检测隧道内的管道。

**适用场景**：

- 只需要检测圆柱形管道
- 点云数据来源于隧道场景

**注意事项**：

- 这是旧版本算法，功能较有限
- 新用户建议使用"运行通用检测"

---

### 三、检测结果

#### 1. 导出检测JSON

**用途**：将检测结果保存为JSON格式文件，便于后续处理或与其他软件对接。

**操作步骤**：

1. 完成检测后，点击"导出检测JSON"
2. 选择保存位置
3. 输入文件名
4. 点击保存

**JSON文件内容示例**：

```json
{
  "num_objects": 3,
  "objects": [
    {
      "shape_type": "cylinder",
      "confidence": 0.95,
      "num_points": 5234,
      "params": {
        "center": [1.2, 0.5, 3.4],
        "axis": [0, 0, 1],
        "radius": 0.25,
        "height": 5.0
      }
    },
    ...
  ]
}
```

#### 2. 清除场景

**用途**：清空当前显示的所有内容，准备进行新的检测。

**操作步骤**：

- 直接点击"清除场景"按钮

---

### 四、批量处理

#### 运行批量推理

**用途**：一次性处理整个文件夹中的多个点云文件。

**操作步骤**：

1. 确保已加载配置和模型
2. 点击"运行批量推理"
3. 选择**输入文件夹**（包含点云文件的文件夹）
4. 选择**输出文件夹**（保存JSON结果的文件夹）
5. 等待批量处理完成

**特点**：

- 自动识别文件夹中所有支持的点云文件
- 每个文件处理后自动生成对应的JSON结果
- 日志窗口实时显示处理进度

**适用场景**：

- 有大量文件需要处理
- 需要无人值守的自动化处理

---

### 五、数据生成

#### 生成数据

**用途**：自动生成训练数据，用于训练自己的模型。

**操作步骤**：

1. 在"训练集"和"测试集"输入框中设置要生成的场景数量
2. 点击"生成数据"按钮
3. 选择输出文件夹
4. 等待生成完成

**参数说明**：

- **训练集**：用于模型训练的场景数量（如100）
- **测试集**：用于模型评估的场景数量（如20）

**生成的数据结构**：

```
output/
├── train/
│   ├── scene_001.npz
│   ├── scene_002.npz
│   └── ...
└── test/
    ├── scene_001.npz
    ├── scene_002.npz
    └── ...
```

---

### 六、训练参数

**用途**：设置模型训练的各项参数。

#### 参数说明

| 参数     | 说明                 | 推荐值 |
| -------- | -------------------- | ------ |
| 训练轮次 | 完整遍历训练集的次数 | 10-100 |
| 批次     | 每次训练使用的样本数 | 4-16   |
| 学习率   | 模型参数更新的步长   | 0.001  |

#### 设置方法

1. 在对应的输入框中修改数值
2. 点击"更新"按钮（运行参数部分）
3. 或者直接启动训练脚本，参数会自动应用

---

### 七、运行参数

**用途**：调整软件运行时的各项参数。

#### 参数说明

| 参数     | 说明                 | 默认值 | 推荐范围     |
| -------- | -------------------- | ------ | ------------ |
| 体素大小 | 点云下采样的网格大小 | 0.05   | 0.01-0.1     |
| 窗口数   | 滑动窗口的最大数量   | 200    | 50-500       |
| 渲染限制 | 3D显示的最大点数     | 50000  | 10000-100000 |

#### 设置方法

1. 修改对应输入框的数值
2. 点击"更新"按钮
3. 日志窗口会显示更新后的参数

**体素大小调整建议**：

- 点云很密集时，增大体素大小可以加速处理
- 需要高精度时，减小体素大小
- 过小的体素会导致处理时间大幅增加

---

### 八、工具

#### 1. 生成测试场景

**用途**：在3D视图中生成一个包含各种形状的测试场景，用于演示或测试。

**操作步骤**：

1. 确保已加载配置文件
2. 点击"生成测试场景"
3. 系统会自动生成一个包含所有定义形状的场景

**用途**：

- 快速了解系统能识别的形状
- 测试可视化功能
- 演示软件功能

#### 2. 启动训练脚本

**用途**：启动模型的训练过程。

**操作步骤**：

1. 确保已加载配置文件
2. 设置好训练参数（训练轮次、批次、学习率）
3. 确保已生成训练数据
4. 点击"启动训练脚本"
5. 观察日志窗口中的训练进度

**训练过程说明**：

- 训练可能需要较长时间（几分钟到几小时）
- 训练过程中日志窗口会实时显示：
  - 当前训练轮次
  - 损失函数值（Loss）
  - 训练进度
- 训练完成后，模型会自动保存

---

## 常见问题

### Q1: 点击按钮没有反应，怎么办？

**可能原因**：

1. 没有加载配置文件
2. 没有加载模型文件
3. 没有导入点云数据
4. 日志窗口显示了错误信息

**解决方法**：

- 检查左侧"配置"和"模型"状态是否显示正确
- 查看下方日志窗口中的错误提示
- 按照操作流程依次完成配置加载→模型加载→数据导入

---

### Q2: 检测速度很慢，如何加速？

**解决方法**：

1. **使用GPU**：确保安装了CUDA版本的PyTorch
2. **调整体素大小**：增大体素大小（如从0.05改为0.1）
3. **减小窗口数**：将窗口数从200降到100或更少
4. **减少渲染点数**：将渲染限制从50000降到20000

---

### Q3: 检测结果不准确，漏检或误检？

**可能原因**：

1. 点云质量较差
2. 形状不完整
3. 模型未针对该场景训练

**解决方法**：

1. 检查点云是否完整
2. 调整体素大小，获得更精细的点云
3. 使用训练数据针对特定场景重新训练模型
4. 查看日志中的置信度数值，低置信度的结果可能不准确

---

### Q4: 无法加载模型文件？

**可能原因**：

1. 模型文件损坏
2. 模型与配置不匹配
3. 文件路径包含中文或特殊字符

**解决方法**：

1. 确认模型文件完整
2. 确保配置文件定义的类别数与模型输出类别数一致
3. 将文件放在纯英文路径下

---

### Q5: 导入点云后看不到任何东西？

**可能原因**：

1. 点云范围超出显示范围
2. 渲染点数限制过小

**解决方法**：

1. 在3D视图中，右键点击选择"Reset Camera"重置视角
2. 增大渲染限制参数（如从50000改为100000）
3. 使用鼠标滚轮缩放查看

---

### Q6: 3D视图操作方法？

| 操作     | 鼠标动作                   |
| -------- | -------------------------- |
| 旋转视角 | 按住左键拖动               |
| 平移视角 | 按住Shift+左键拖动         |
| 缩放     | 滚动鼠标滚轮               |
| 重置视角 | 右键菜单选择"Reset Camera" |

---

### Q7: 如何查看系统是否使用GPU？

**方法**：
查看软件启动时的日志，或者观察检测速度。使用GPU时，百万级别的点云通常在几秒到几十秒内完成检测。

如果只有CPU可用，可以在日志中看到"device=cpu"的提示。

---

### Q8: 日志窗口显示错误怎么办？

**常见错误及解决**：

| 错误信息              | 原因             | 解决方法             |
| --------------------- | ---------------- | -------------------- |
| Config is not loaded  | 没有加载配置文件 | 先点击"加载配置文件" |
| No point cloud loaded | 没有点云数据     | 先点击"导入点云文件" |
| Model file not found  | 模型文件不存在   | 检查模型路径是否正确 |
| CUDA out of memory    | 显存不足         | 减小批次大小或窗口数 |

---

## 进阶使用

### 自定义配置文件

如果要检测自定义的形状，可以编辑 `config/shape_config.yaml`：

```yaml
# 定义需要识别的形状
shapes:
  cylinder: 圆柱体
  sphere: 球体
  plane: 平面
  # 添加自定义形状
  cone: 圆锥体

# 场景边界
scene:
  bounds:
    min: [-5, -5, -5]
    max: [5, 5, 5]

# 每种形状的参数
cylinder:
  params:
    radius_range: [0.1, 1.0]
    height_range: [1.0, 5.0]
  fitting:
    distance_threshold: 0.05
    ransac_n: 3
    num_iterations: 1000
  min_points: 100
```

### 训练自己的模型

如果通用模型在特定场景下表现不佳，可以训练专用模型：

1. 准备训练数据
   - 收集特定场景的点云数据
   - 进行标注（标注每个点属于哪个形状）
   - 或使用"生成数据"功能生成合成数据

2. 设置训练参数
   - 根据数据量调整训练轮次
   - 根据显存大小调整批次

3. 启动训练
   - 点击"启动训练脚本"
   - 等待训练完成

4. 保存并使用新模型
   - 训练好的模型会自动保存
   - 使用"加载模型权重"加载新模型进行检测

### 命令行使用

除了GUI，也可以通过命令行运行：

```bash
# 运行主程序
python main.py

# 运行训练脚本
python scripts/train_universal.py --config config/shape_config.yaml --epochs 50

# 运行单文件推理
python scripts/inference.py --input data/scene.npz --output result.json
```

---

## 技术支持

如果遇到以上文档未覆盖的问题：

1. 查看软件根目录下的日志文件（如果有）
2. 检查控制台输出的详细错误信息
3. 确认所有依赖库已正确安装
4. 尝试重启软件或计算机

---

## 附录：术语解释

| 术语       | 解释                                         |
| ---------- | -------------------------------------------- |
| 点云       | 由大量3D坐标点组成的数据，表示物体的表面     |
| 深度学习   | 一种机器学习方法，使用神经网络自动学习特征   |
| PointNet++ | 一种专门处理点云数据的深度神经网络           |
| RANSAC     | 随机抽样一致性算法，用于从噪声数据中拟合模型 |
| 体素       | 3D空间的像素，用于点云的下采样               |
| 置信度     | 模型对检测结果的确定程度，范围0-1            |
| 滑动窗口   | 将大数据分割成小块进行处理的方法             |

---

## 更新日志

- v1.0 - 初始版本
  - 支持圆柱、球体、平面检测
  - 基础GUI界面
  - 单文件检测功能

- v2.0 - 通用检测版本
  - 支持多种形状检测
  - 批量处理功能
  - 数据生成功能

---

**祝您使用愉快！**
